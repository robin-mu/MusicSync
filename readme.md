**Note**: This project is still in development, so many of the features described don't work yet.

# MusicSync
Sync your online music/video libraries with your local files.

# Features
- Works with any [yt-dlp](https://github.com/yt-dlp/yt-dlp)-supported URLs
- Organize your URLs in folders and collections
- Many options for each collection: file name and format, 
- Fully customizable metadata suggestions with regex, filter and replace functionality
- CLI for automatic synchronization
- Plugins for advanced metadata and file operations

# Installation
```shell
git clone https://github.com/robin-mu/MusicSync.git
cd MusicSync
pip install yt-dlp pandas
```

## Required dependencies
- yt-dlp
- pandas

## Optional dependencies
- ffmpeg binaries (CLI program, not the python package)
- pyside6
- mutagen
- syncedlyrics

# Usage

# Documentation
## Terminology
- **Collection**: A group of URLs which are processed using the same settings.
- **URL**/**Collection URL**: Any URL supported by yt-dlp. A URL contains one or multiple Tracks.
- **Track**: One single video/audio found _online_. A track has a URL which can be different from its parent Collection URL (in the case of a playlist) or be the same (in the case of a single video/audio).
- **File**: A video/audio file on _local_ storage. Note that a Track and a File can refer to the same song, but the Track refers to the remote version and the File to the local version of that song.
- **Metadata table**: A csv file with Track URLs (which can, but don't have to be Collection URLs) as first column, and columns holding any Track metadata after that.

## Library
A library contains your collections organized in a folder structure. It is linked to a metadata table, where all downloaded metadata and custom metadata generated by the collection will be saved. A library can also reference other metadata tables, see ["Metadata suggestions"](#metadata-suggestions) on how to add external metadata tables.  
You can manage your library in the tree view on the left. 

## Collections and URLs
A collection is a group of URLs which are processed using the same settings. URLs can be added in the library view.  
Right-clicking a collection brings up a context menu with the following options:
- **Import URLs from bookmarks**: Brings up a dialog in which you can select the bookmarks file of your browser and the folder whose bookmarks to add to the collection. The following browsers are supported:
  - *Firefox*: Select the file `places.sqlite` in your Firefox profile folder. Sometimes, the file will be locked by Firefox if it is open when MusicSync wants to access it. In this case, you have to close Firefox and try again.

Right-clicking a URL brings up a context menu with the following options:
- **Exclude URL from sync**: If this is enabled, the URL data will not be compared to your local files when syncing in the "File sync status" tab. This is useful if URL data like playlist entries don't change, e.g. when it is an album.
- **Concatenate videos of playlist**: If this is enabled and yt-dlp reports that the URL is a playlist, its videos will be concatenated into one file. This is useful e.g. if you have a playlist of songs of an album, but you want to have the album saved as one audio file.

After selecting a collection, you can use the various tabs at the top. The first three are for managing downloads and selecting metadata and file tags, while the last three are for configuring collection settings.

### File sync
In this table, you see how many online **Tracks** are downloaded as **Files**, and you can decide what to do with your files.  
Clicking the "Compare" button will download info of all URLs of this collection without downloading any actual files. A **sync status** is determined, and you can select a **sync action** for each track in the table before syncing the collection.

#### Sync status and sync actions
Depending on the relationship between an online track and the corresponding local file, a **sync status** will be determined before syncing. This is especially useful for playlists whose contents can change in many ways (tracks added, removed by you, removed by the site etc.) which should all be handled differently. Possible values for the sync status are
- **Track added to URL**: Track is present online, but was not present in the previous sync.
- **Track not downloaded**: Track is present online, was also present in previous sync, but a corresponding file does not exist.
- **Track removed from URL**: Track is not present online, but was present in the previous sync.
- **File only exists locally**: The file is not marked as permanently downloaded and does not correspond to a track found online.
- **File permanently downloaded**: The file is marked as permanently downloaded (even though its corresponding track might not exist anymore).
- **File downloaded**: Track is present online and the corresponding file exists.

Each sync status can result in different **sync actions**. Possible sync actions are
- **Download**: Download the file.
- **Delete**: Delete the file.
- **Do nothing**: Don't delete or download a file and don't change the configuration.
- **Mark as permanently downloaded**: Don't delete the file, and mark it as permanently downloaded. This means the file's sync status won't be "Track not downloaded" or "Track removed from URL" in the future, but simply "File permanently downloaded" and can thus be distinguished from other removed tracks during future syncs.
- **Mark as not permanently downloaded**: Mark the file as not permanently downloaded (but don't delete the file).
- **Redownload metadata**: Download metadata again, but don't download the actual file again.
- **Decide individually**: You have to pick an action in each case. Syncing can only start when none of the selected actions are "Decide individually".

Not every sync status can result in every sync action.

---

Clicking the "Sync" button will execute all selected sync actions, i.e. downloading files, deleting files etc. Metadata suggestions can then be selected and applied in the ["Metadata"](#metadata) tab.

### Metadata

### File tags

### Formatting
Many settings in the following three settings tabs use format strings following [yt-dlp\'s output template](https://github.com/yt-dlp/yt-dlp?tab=readme-ov-file#output-template) syntax to set metadata or file data. Referencing yt-dlp's downloaded metadata works exactly like described there. There are also additional features:
- Custom metadata fields from the connected metadata table can be referenced with `0:[field]` and fields from external tables with `[id]:[field]` (so the connected metadata table always has id 0).
- Data from [metadata plugins](#metadata-plugins) can be requested with `[plugin_name]:[arg1];[arg2];...;[kwarg1_key]=[kwarg1_value];...`. See the ["Plugins"](#plugins) section for available built-in plugins and how to add your own.

### Collection settings
The following settings are available:

#### General settings
- **Folder path**: The base folder where all tracks in this collection will be saved.
- **Filename format**: [Formatted](#formatting) setting determining the filename for downloaded tracks. The file extension will be appended automatically. The filename will be generated last, so you can include data from custom metadata fields and file tags in the format string. Default: `%(title)s [%(id)s]` (same as yt-dlp)
- **File extension**
- **URL name format**: [Formatted](#formatting) setting determining the name of the URL. Default: `%(title)s`
- **Save playlist-type URLs in subfolders**: if yt-dlp reports that a URL is a playlist, its tracks will be saved in a subfolder of the collection's folder path. The name of the subfolder is the same as the URL name.
- **Automatically exclude URLs after first download**: Can be useful for playlists whose contents don't change and don't have to be synced after the first download, e.g. albums.
- **Automatically concatenate videos for these URLs**: A comma-separated list of URLs (regex supported) whose videos will be automatically concatenated into one file if yt-dlp reports them to be a playlist. A literal comma has to be escaped like `\,`.
- **Exclude these yt-dlp fields from the metadata table**: yt-dlp's info dicts contain data that is not relevant metadata or too big to be saved in the metadata table. [These](https://github.com/yt-dlp/yt-dlp/blob/master/yt_dlp/extractor/common.py#L124-L487) are all fields that info-dict can contain, but certain pages also set additional fields. In this setting you can provide a comma-separated list of fields which are not saved in the metadata table. They are still saved temporarily so that they can be accessed in metadata selection right after downloading, but are deleted when MusicSync is closed, so they can not be accessed in metadata selection in the future without redownloading metadata first.
---

#### Sync this collection with a bookmark folder
Brings up the bookmark import dialog where you can select the folder this collection should be synced to. Before syncing, MusicSync looks for the bookmark folder in the browser's database, adding all new URLs to the collection and removing all deleted URLs. If URLs are removed, you will be asked whether MusicSync should also delete the corresponding files.  
If bookmark sync is enabled, no URLs can be manually added to or removed from the collection.  
If you stop syncing, all the URLs will stay but won't be synced to the bookmark folder anymore.

---

#### Default sync actions
Here, you can select the sync action that will be the pre-set value of the combobox in the [file sync table](#file-sync), depending on the determined sync status.

---

### Metadata suggestions
In this tab, you can add custom metadata fields and suggestions that will be generated for them and out of which you can select in the ["Metadata"](#metadata) tab.

#### Metadata fields table
In the upper table, you can add custom metadata fields.

- **Enabled**: Whether suggestions for this field will be generated and shown in the "Metadata" tab.
- **Name**: The name of the field under which your selected metadata will be saved in your library's metadata table.
- **Timed**: Whether this field contains timed data such as chapters, subtitles or lyrics in LRC format. Timed fields will have a special editor in the "Metadata" tab.
- **Show format options**: If this is enabled, the suggestion box for this field will have additional format options next to it in the "Metadata" tab.
- **Default for format option "Format as title"**: Whether the format option "Format as title" will be enabled by default. This format option will capitalize every word.
- **Default for format option "Remove brackets"**: Whether the format option "Format as title" will be enabled by default. This format option removes every pair of brackets and between them (like "(text)", "[text]" or "{text}").

#### Metadata suggestions table
In the lower table, you can configure which suggestions will be generated for the selected metadata field. The order is important, so the first row of the table will be the top suggestion in the "Metadata" tab. There is one exception to this: If this library's metadata table already has data for a track and field, the table data will always be placed as the first (and therefore selected by default) suggestion. This ensures that the default operation in the "Metadata" tab is not to change any present data (You can imagine it as every field called `[field]` having an invisible first row with the format `%(0:[field])s`).

- **Format**: [Format string](#formatting) to generate the suggestion from. This corresponds to the `FROM` field in yt-dlp's [`--parse-metadata`](https://github.com/yt-dlp/yt-dlp/tree/master?tab=readme-ov-file#modifying-metadata) option.
- **Filter**: [Regex](https://docs.python.org/3/library/re.html#regular-expression-syntax) to filter the format string. Similar to `TO` in yt-dlp's [`--parse-metadata`](https://github.com/yt-dlp/yt-dlp/tree/master?tab=readme-ov-file#modifying-metadata) option, but only text inside the first unnamed capture group will be kept as the suggestion.
- **Replace**: [Regex](https://docs.python.org/3/library/re.html#regular-expression-syntax) to replace in the filtered string. Same as `REGEX` in yt-dlp's [`--replace-in-metadata`](https://github.com/yt-dlp/yt-dlp/tree/master?tab=readme-ov-file#modifying-metadata) option. If this is empty, no replacement will take place.
- **Replace with**: Format string to replace the regex with. Same as `REPLACE` in yt-dlp's [`--replace-in-metadata`](https://github.com/yt-dlp/yt-dlp/tree/master?tab=readme-ov-file#modifying-metadata), but the string may also be formatted like `FROM` in `--parse-metadata`.
- **Split at**: Comma-separated list of separators along each of which the resulting string (after filtering and replacing) will be split (separately, so first the string will be split by the first separator and every entry becomes one suggestion, then the string will be split by the second separator and every entry becomes another suggestion etc.). Every split entry will become one suggestion. A comma inside a separator has to be escaped like `\,`
- **Index/Slice**: Index or python slice (like `[start]:[stop]:[step]`) to process the resulting list of suggestions.
- **Conditions**: Comma-separated list of conditions. Syntax is the same as for the [--match-filters](https://github.com/yt-dlp/yt-dlp?tab=readme-ov-file#video-selection) option of yt-dlp. The suggestion will only be generated if at least one of the conditions is true.

### File tags and operations
In this table, you can select the tags that should be added to downloaded files and their respective values. You can also execute various file operations via [file plugins](#file-plugins).

- **Name**: The name of the tag. Note that not every file format supports every tag name, so try to only select tag names from the drop-down list at the top, but your file format might not even support every one of these. If an unknown tag name is given, the data will be saved as a comment (if the file format supports comments), so your music player might not be able to recognize that tag. See the [table below](#supported-file-tags-depending-on-file-format) for an overview on supported file tags for various file formats.
- **Format**: [Format string](#formatting) to generate the tag from.

#### Supported file tags depending on file format


## Plugins
Plugins are files in the `plugins` folder. There are metadata plugins and file plugins:
- **Metadata plugins** can be requested in any formatting field (`%(name)s`) in [formatted settings](#formatting). They receive the metadata table row of the current track as well as information about the current collection.
- **File plugins** can be requested from a [tag name](#file-tags-and-operations). They receive the same info as metadata plugins, but can additionally modify the Track entry of the Collection URL, e.g. by changing the filename.

Plugin syntax is `[plugin_name]:[arg1];[arg2];...;[kwarg1_key]=[kwarg1_value];[kwarg2_key]=[kwarg2_value];...`. The colon has to be present even if no arguments are given.

### Built-in plugins
#### Metadata plugins
- `collection:[setting]`: Access collection settings
- `ext_lyrics:[query]`: Downloads lyrics from external sources (with the [syncedlyrics](https://pypi.org/project/syncedlyrics/) package) using the [format string](#formatting) `[query]` as the search term, and returns them as timed data.
- `concat_playlist_timed:[format]`: Generates timed data from the individual videos of playlist-type urls for which concatenation is enabled, using their start time in the concatenated video as time and the [format string](#formatting) `[format]` as the timed text.
- `tag:[name]`: Access the generated [tag](#file-tags-and-operations) with the specified name. Since tag generation happens after metadata suggestion generation, this plugin might not work for metadata suggestions.

#### File plugins
- `thumbnail:[name]`: The file at the path/URL that this tag is set to is embedded into the file as an image. mutagen's [PictureType](https://mutagen.readthedocs.io/en/latest/api/id3.html#mutagen.id3.PictureType) is used as possible values for `[name]`. If no name is set, the image will be embedded as `FRONT_COVER`.
- `cut:` If this tag is set to a timed metadata field, chapters with special names will be used to cut the file or add silence.

### Adding your own plugin
